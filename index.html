<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Or√ßamentos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .logo { width: 250px; height: 100px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); object-fit: contain; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
        .content { padding: 40px; }
        .section { margin-bottom: 40px; padding: 30px; background: #f8f9fa; border-radius: 15px; border-left: 5px solid #FF6B35; }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: white; }
        .form-group input[readonly] { background: #f8f9fa; color: #6c757d; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #FF6B35; box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #343a40 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; padding: 8px 15px; font-size: 0.9rem; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .items-table th { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); color: white; padding: 15px; text-align: left; font-weight: 600; }
        .items-table td { padding: 15px; border-bottom: 1px solid #e9ecef; }
        .total-section { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); color: white; padding: 25px; border-radius: 15px; text-align: right; margin-top: 20px; }
        .total-section h3 { font-size: 1.8rem; margin-bottom: 10px; }
        .total-section p { font-size: 2.5rem; font-weight: 700; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        .modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); }
        .modal-header { text-align: center; margin-bottom: 30px; }
        .share-options { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
        .share-option { display: flex; align-items: center; gap: 15px; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; cursor: pointer; transition: all 0.3s ease; }
        .share-option:hover { border-color: #FF6B35; background: #fff5f2; transform: translateY(-2px); }
        .share-option-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; flex-shrink: 0; }
        .share-option-content h3 { margin: 0 0 5px 0; color: #2c3e50; }
        .share-option-content p { margin: 0; color: #6c757d; font-size: 0.9rem; }
        .download-icon { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); }
        .image-icon { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .whatsapp-icon { background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); }
        .modal-footer { text-align: center; padding-top: 20px; border-top: 1px solid #e9ecef; }
        .btn-close { background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://i.imgur.com/zerV906.png" alt="Fenix Fardamentos Logo" class="logo">
            </div>
            <h1>Gerador de Or√ßamentos</h1>
        </div>
        <div class="content">
            <div class="section">
                <h2>üè¢ Dados da Empresa</h2>
                <div class="form-grid">
                    <div class="form-group"><label>Nome</label><input type="text" value="Fenix Fardamentos LTDA" readonly></div>
                    <div class="form-group"><label>CNPJ</label><input type="text" value="12.000.234/0001-18" readonly></div>
                    <div class="form-group"><label>Endere√ßo</label><input type="text" value="Rua Pinheiro, 65 - Cidade Universit√°ria" readonly></div>
                    <div class="form-group"><label>Telefone</label><input type="text" value="(82) 98814-4752" readonly></div>
                    <div class="form-group"><label>E-mail</label><input type="email" value="fenixfardamentos.al@gmail.com" readonly></div>
                </div>
            </div>

            <div class="section">
                <h2>üë§ Dados do Cliente</h2>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="clienteExistente">Selecionar Cliente Existente</label>
                    <select id="clienteExistente" onchange="preencherCliente()">
                        <option value="">-- Novo Cliente --</option>
                    </select>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label for="clienteNome">Nome do Cliente *</label><input type="text" id="clienteNome" placeholder="Nome completo ou empresa" required></div>
                    <div class="form-group"><label for="clienteCnpjCpf">CPF / CNPJ</label><input type="text" id="clienteCnpjCpf" placeholder="Digite o CPF ou CNPJ" oninput="formatarCnpjCpf(this)" maxlength="18"></div>
                    <div class="form-group"><label for="clienteEmail">E-mail</label><input type="email" id="clienteEmail" placeholder="cliente@email.com"></div>
                    <div class="form-group"><label for="clienteTelefone">Telefone</label><input type="text" id="clienteTelefone" placeholder="(11) 99999-9999" oninput="formatarTelefone(this)"></div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="salvarCliente()">üíæ Salvar Novo Cliente</button>
            </div>

            <div class="section">
                <h2>üì¶ Adicionar Itens ao Or√ßamento</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="itemDescricao">Descri√ß√£o do Item *</label><input type="text" id="itemDescricao" placeholder="CAMISA UV" required></div>
                    <div class="form-group"><label for="itemQuantidade">Quantidade *</label><input type="number" id="itemQuantidade" min="1" value="1" required></div>
                    <div class="form-group"><label for="itemValorUnitario">Valor Unit√°rio (R$)</label><input type="text" id="itemValorUnitario" placeholder="0,00" oninput="formatarCampoMoeda(this)" required></div>
                </div>
                <button type="button" class="btn btn-primary" onclick="adicionarItem()">‚ûï Adicionar Item</button>
            </div>

            <div class="section">
                <h2>üìã Itens do Or√ßamento</h2>
                <div id="itensContainer"><div class="empty-state"><h3>Nenhum item adicionado</h3><p>Adicione itens ao or√ßamento.</p></div></div>
                <div id="totaisContainer"></div>
            </div>

            <div class="section">
                <h2>üìù Observa√ß√µes</h2>
                <div class="form-group"><label for="observacoes">Observa√ß√µes Adicionais</label><textarea id="observacoes" placeholder="Condi√ß√µes de pagamento, prazo de entrega, garantias, etc.">Forma de pagamento: 50% na encomenda e 50% na entrega. Prazo de entrega: 30 dias a partir da confirma√ß√£o do pedido.</textarea></div>
            </div>

            <div class="section" style="text-align: center;">
                <button type="button" class="btn btn-success" onclick="gerarPDF()">üìÑ Gerar Or√ßamento em PDF</button>
            </div>
        </div>
        <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 11px;">v4.2.2-vercel</div>
    </div>
    
    <div id="shareModal" class="modal-overlay">
         <div class="modal-content">
            <div class="modal-header"><h2>üì§ Compartilhar Or√ßamento</h2><p>Escolha como deseja salvar ou compartilhar</p></div>
            <div class="share-options">
                <div class="share-option" onclick="baixarPDF()">
                    <div class="share-option-icon download-icon">üìÑ</div>
                    <div class="share-option-content"><h3>Baixar PDF</h3><p>Documento completo</p></div>
                </div>
                <div class="share-option" onclick="baixarImagem()">
                    <div class="share-option-icon image-icon">üñºÔ∏è</div>
                    <div class="share-option-content"><h3>Baixar Imagem</h3><p>Resumo em JPEG</p></div>
                </div>
                <div class="share-option" onclick="encaminharWhatsApp()">
                    <div class="share-option-icon whatsapp-icon">üí¨</div>
                    <div class="share-option-content"><h3>WhatsApp</h3><p>Enviar para o cliente</p></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-close" onclick="fecharModal()">Fechar</button></div>
        </div>
    </div>

    <script>
        let itens = [];
        let contadorItens = 0;
        let clientesCache = [];
        let pdfGerado = null;
        let dadosOrcamento = null;

        // --- FUN√á√ïES DO BACKEND (API) ---
        async function carregarClientes() {
            const select = document.getElementById('clienteExistente');
            select.innerHTML = '<option value="">-- Carregando... --</option>';
            try {
                const response = await fetch('/api/clientes');
                if (!response.ok) throw new Error(`Falha na rede: ${response.statusText}`);
                const clientes = await response.json();
                clientesCache = clientes;
                select.innerHTML = '<option value="">-- Novo Cliente --</option>';
                clientes.forEach(cliente => {
                    const option = new Option(`${cliente.codigo_cliente} - ${cliente.nome}`, cliente.id);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
                select.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        function preencherCliente() {
            const select = document.getElementById('clienteExistente');
            const clienteId = select.value;
            const cliente = clientesCache.find(c => c.id == clienteId);

            document.getElementById('clienteNome').value = cliente ? cliente.nome : '';
            document.getElementById('clienteEmail').value = cliente ? cliente.email : '';
            const telefoneInput = document.getElementById('clienteTelefone');
            telefoneInput.value = cliente ? cliente.telefone : '';
            if (cliente && cliente.telefone) formatarTelefone(telefoneInput);
            const cnpjCpfInput = document.getElementById('clienteCnpjCpf');
            cnpjCpfInput.value = cliente ? cliente.cnpj_cpf : '';
            if (cliente && cliente.cnpj_cpf) formatarCnpjCpf(cnpjCpfInput);
        }

        async function salvarCliente() {
            const nome = document.getElementById('clienteNome').value.trim();
            const cnpj_cpf = document.getElementById('clienteCnpjCpf').value.trim();
            if (!nome) {
                alert('O nome do cliente √© obrigat√≥rio para salvar.');
                return;
            }
            const docLimpo = cnpj_cpf.replace(/\D/g, '');
            if (docLimpo.length > 0) {
                if (docLimpo.length === 11 && !validarCPF(docLimpo)) { alert('CPF inv√°lido.'); return; }
                else if (docLimpo.length === 14 && !validarCNPJ(docLimpo)) { alert('CNPJ inv√°lido.'); return; }
                else if (docLimpo.length !== 11 && docLimpo.length !== 14) { alert('CPF/CNPJ com n√∫mero de d√≠gitos incorreto.'); return; }
            }
            if (clientesCache.some(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                alert('Um cliente com este nome j√° existe.');
                return;
            }
            const email = document.getElementById('clienteEmail').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim();
            try {
                const response = await fetch('/api/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, telefone, cnpj_cpf })
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Erro do servidor');
                alert(`Cliente "${nome}" salvo com sucesso!`);
                carregarClientes();
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                alert(`Ocorreu um erro ao salvar: ${error.message}`);
            }
        }
        
        // --- FUN√á√ïES DE VALIDA√á√ÉO E FORMATA√á√ÉO ---
        function formatarTelefone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) { value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3'); } 
            else if (value.length > 2) { value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3'); } 
            else if (value.length > 0) { value = `(${value}`; }
            input.value = value;
        }

        function formatarCnpjCpf(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
                valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
                valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
            }
            input.value = valor;
        }

        function validarCPF(cpf){cpf=cpf.replace(/\D/g,"");if(11!==cpf.length||/^(\d)\1+$/.test(cpf))return!1;let t,e=0;for(t=1;t<=9;t++)e+=parseInt(cpf.substring(t-1,t))*(11-t);if(e=10*(e=10*e%11)%11,10!==e&&11!==e||(e=0),e!==parseInt(cpf.substring(9,10)))return!1;for(e=0,t=1;t<=10;t++)e+=parseInt(cpf.substring(t-1,t))*(12-t);return e=10*(e=10*e%11)%11,10!==e&&11!==e||(e=0),e===parseInt(cpf.substring(10,11))}
        function validarCNPJ(cnpj){cnpj=cnpj.replace(/\D/g,"");if(14!==cnpj.length||/^(\d)\1+$/.test(cnpj))return!1;let t=cnpj.length-2,e=cnpj.substring(0,t),n=cnpj.substring(t),r=0,o=t-7;for(let a=t;a>=1;a--)r+=e.charAt(t-a)*o--,o<2&&(o=9);let a=r%11<2?0:11-r%11;if(a!=n.charAt(0))return!1;for(t+=1,e=cnpj.substring(0,t),r=0,o=t-7,a=t;a>=1;a--)r+=e.charAt(t-a)*o--,o<2&&(o=9);return a=r%11<2?0:11-r%11,a==n.charAt(1)}
        
        function formatarCampoMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            if(valor === '') { input.value = ''; return; }
            valor = (parseInt(valor, 10) / 100).toFixed(2) + '';
            valor = valor.replace('.', ',');
            const regex = /(\d)(?=(\d{3})+(?!\d))/g;
            input.value = valor.replace(regex, '$1.');
        }

        // --- FUN√á√ïES DO GERADOR (ITENS, TOTAIS, PDF) ---
        function parseCurrency(value) {
            if (!value) return 0;
            return parseFloat(String(value).replace(/\./g, '').replace(',', '.')) || 0;
        }

        function adicionarItem() {
            const descricao = document.getElementById('itemDescricao').value.trim();
            const quantidade = parseInt(document.getElementById('itemQuantidade').value);
            const valorUnitario = parseCurrency(document.getElementById('itemValorUnitario').value);
            if (!descricao || isNaN(quantidade) || quantidade <= 0 || isNaN(valorUnitario) || valorUnitario <= 0) {
                alert('Por favor, preencha todos os campos do item com valores v√°lidos.');
                return;
            }
            const item = { id: ++contadorItens, descricao, quantidade, valorUnitario, valorTotal: quantidade * valorUnitario };
            itens.push(item);
            atualizarTabelaItens();
            limparFormularioItem();
        }

        function removerItem(id) {
            itens = itens.filter(item => item.id !== id);
            atualizarTabelaItens();
        }

        function limparFormularioItem() {
            document.getElementById('itemDescricao').value = '';
            document.getElementById('itemQuantidade').value = '1';
            document.getElementById('itemValorUnitario').value = '';
        }

        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function atualizarTabelaItens() {
            const container = document.getElementById('itensContainer');
            if (itens.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Nenhum item adicionado</h3></div>`;
            } else {
                 container.innerHTML = `
                    <table class="items-table">
                        <thead><tr><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√µes</th></tr></thead>
                        <tbody>
                            ${itens.map(item => `
                                <tr>
                                    <td>${item.descricao}</td>
                                    <td>${item.quantidade}</td>
                                    <td>${formatarMoeda(item.valorUnitario)}</td>
                                    <td>${formatarMoeda(item.valorTotal)}</td>
                                    <td><button class="btn btn-danger" onclick="removerItem(${item.id})">üóëÔ∏è</button></td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            }
            atualizarTotais();
        }

        function atualizarTotais() {
            const totaisContainer = document.getElementById('totaisContainer');
            const subtotal = itens.reduce((acc, item) => acc + item.valorTotal, 0);
            const desconto = parseCurrency(document.getElementById('descontoValor')?.value);
            const totalGeral = subtotal - desconto;
            
            totaisContainer.innerHTML = `
                <div class="total-section">
                    <div class="form-grid" style="margin-bottom: 20px; text-align: left;">
                        <div class="form-group">
                            <label for="descontoValor" style="color: white;">Desconto (R$)</label>
                            <input type="text" id="descontoValor" placeholder="0,00" oninput="formatarCampoMoeda(this); atualizarTotais();" value="${document.getElementById('descontoValor')?.value || ''}">
                        </div>
                    </div>
                    <p style="font-size: 1rem;">Subtotal: ${formatarMoeda(subtotal)}</p>
                    <p style="font-size: 1rem; margin-bottom: 10px;">Desconto: - ${formatarMoeda(desconto)}</p>
                    <h3>Total Geral</h3>
                    <p>${formatarMoeda(totalGeral)}</p>
                </div>`;
        }

        function gerarPDF() {
            const clienteNome = document.getElementById('clienteNome').value.trim();
            if (!clienteNome || itens.length === 0) {
                alert('Preencha o nome do cliente e adicione pelo menos um item.');
                return;
            }
            dadosOrcamento = { clienteNome, totalGeral: itens.reduce((t, e) => t + e.valorTotal, 0) };
            criarPDF();
        }

        function criarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            let yPosition = 20;

            const logoImg = new Image();
            logoImg.crossOrigin = 'anonymous';
            logoImg.onload = function() {
                const logoWidth = 60, logoHeight = 25;
                const logoX = (pageWidth - logoWidth) / 2;
                doc.addImage(this, 'PNG', logoX, yPosition, logoWidth, logoHeight);
                yPosition += logoHeight + 5;
                continuarGeracaoPDF(doc, pageWidth, margin, yPosition);
            };
            logoImg.onerror = () => {
                yPosition += 10;
                continuarGeracaoPDF(doc, pageWidth, margin, yPosition);
            };
            logoImg.src = 'https://i.imgur.com/zerV906.png';
        }

        function continuarGeracaoPDF(doc, pageWidth, margin, yPosition) {
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(44, 62, 80);
            doc.text('OR√áAMENTO', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;

            const infoStartY = yPosition;
            let leftY = infoStartY;
            let rightY = infoStartY;
            const halfWidth = pageWidth / 2;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(44, 62, 80);
            doc.text('DADOS DA EMPRESA', margin, leftY);
            leftY += 5;
            doc.setLineWidth(0.2);
            doc.line(margin, leftY, halfWidth - margin / 2, leftY);
            leftY += 8;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'bold');
            doc.text(document.querySelector('input[value="Fenix Fardamentos LTDA"]').value, margin, leftY);
            leftY += 6;
            doc.setFont('helvetica', 'normal');
            doc.text(`CNPJ: ${document.querySelector('input[value="12.000.234/0001-18"]').value}`, margin, leftY); leftY += 5;
            doc.text(document.querySelector('input[value="Rua Pinheiro, 65 - Cidade Universit√°ria"]').value, margin, leftY); leftY += 5;
            doc.text(`Telefone: ${document.querySelector('input[value="(82) 98814-4752"]').value}`, margin, leftY); leftY += 5;
            doc.text(`E-mail: ${document.querySelector('input[value="fenixfardamentos.al@gmail.com"]').value}`, margin, leftY); leftY += 5;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(44, 62, 80);
            doc.text('DADOS DO CLIENTE', halfWidth, rightY);
            rightY += 5;
            doc.line(halfWidth, rightY, pageWidth - margin, rightY);
            rightY += 8;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'bold');
            doc.text(document.getElementById('clienteNome').value.trim(), halfWidth, rightY);
            rightY += 6;
            doc.setFont('helvetica', 'normal');
            const clienteEmail = document.getElementById('clienteEmail').value.trim();
            if (clienteEmail) { doc.text(`E-mail: ${clienteEmail}`, halfWidth, rightY); rightY += 5; }
            const clienteTelefone = document.getElementById('clienteTelefone').value.trim();
            if (clienteTelefone) { doc.text(`Telefone: ${clienteTelefone}`, halfWidth, rightY); rightY += 5; }
            const clienteCnpjCpf = document.getElementById('clienteCnpjCpf').value.trim();
            if (clienteCnpjCpf) { doc.text(`CPF/CNPJ: ${clienteCnpjCpf}`, halfWidth, rightY); rightY += 5; }

            yPosition = Math.max(leftY, rightY) + 15;

            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 107, 53);
            doc.text('ITENS DO OR√áAMENTO:', margin, yPosition);
            yPosition += 12;

            const tableData = itens.map((item, index) => [
                index + 1, item.descricao, item.quantidade, formatarMoeda(item.valorUnitario), formatarMoeda(item.valorTotal)
            ]);
            doc.autoTable({
                head: [['#', 'Descri√ß√£o', 'Qtd', 'V. Unit√°rio', 'Total']],
                body: tableData,
                startY: yPosition,
                theme: 'grid',
                headStyles: { fillColor: [255, 107, 53], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: { halign: 'center', cellWidth: 10 }, 1: { halign: 'left' }, 2: { halign: 'center', cellWidth: 15 }, 3: { halign: 'right', cellWidth: 30 }, 4: { halign: 'right', cellWidth: 30 } },
                didDrawPage: (data) => { yPosition = data.cursor.y; }
            });
            yPosition = doc.previousAutoTable.finalY;

            const subtotal = dadosOrcamento.totalGeral;
            const desconto = parseCurrency(document.getElementById('descontoValor')?.value);
            const totalFinal = subtotal - desconto;
            yPosition += 10;
            const totalBoxX = pageWidth / 2;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(80, 80, 80);
            doc.text('Subtotal:', totalBoxX, yPosition, { align: 'left' });
            doc.text(formatarMoeda(subtotal), pageWidth - margin, yPosition, { align: 'right' });
            yPosition += 7;
            doc.text('Desconto:', totalBoxX, yPosition, { align: 'left' });
            doc.text(`- ${formatarMoeda(desconto)}`, pageWidth - margin, yPosition, { align: 'right' });
            yPosition += 7;
            doc.setLineWidth(0.3);
            doc.setDrawColor(150, 150, 150);
            doc.line(totalBoxX, yPosition, pageWidth - margin, yPosition);
            yPosition += 8;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(44, 62, 80);
            doc.text('TOTAL GERAL:', totalBoxX, yPosition, { align: 'left' });
            doc.text(formatarMoeda(totalFinal), pageWidth - margin, yPosition, { align: 'right' });
            yPosition += 15;

            const observacoes = document.getElementById('observacoes').value.trim();
            if (observacoes) {
                const pageHeight = doc.internal.pageSize.height;
                const footerHeight = 25;
                const obsLines = doc.splitTextToSize(observacoes, pageWidth - margin * 2);
                if (yPosition + (obsLines.length * 5) + 15 > pageHeight - footerHeight) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(44, 62, 80);
                doc.text('OBSERVA√á√ïES', margin, yPosition);
                yPosition += 5;
                doc.setLineWidth(0.2);
                doc.line(margin, yPosition, 60, yPosition);
                yPosition += 8;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                doc.text(obsLines, margin, yPosition);
            }

            const dataAtual = new Date();
            const dataFormatada = dataAtual.toLocaleDateString('pt-BR');
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                const pageHeight = doc.internal.pageSize.height;
                const footerY = pageHeight - 15;
                doc.setLineWidth(0.3);
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, footerY, pageWidth - margin, footerY);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(120, 120, 120);
                doc.text(`Emitido em: ${dataFormatada}`, margin, footerY + 5);
                doc.text('Este or√ßamento tem validade de 30 dias.', pageWidth / 2, footerY + 5, { align: 'center' });
                doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth - margin, footerY + 5, { align: 'right' });
            }
            pdfGerado = doc;
            document.getElementById('shareModal').style.display = 'flex';
        }

        function encaminharWhatsApp() {
            const telefoneCliente = document.getElementById('clienteTelefone').value;
            if (!telefoneCliente) {
                alert('O campo de telefone do cliente est√° vazio.');
                return;
            }
            const numeroLimpo = '55' + telefoneCliente.replace(/\D/g, '');
            const nomeCliente = document.getElementById('clienteNome').value.trim() || 'Cliente';
            const mensagem = `Ol√°, ${nomeCliente}! Segue o or√ßamento solicitado. Para concluir, por favor anexe o arquivo PDF que voc√™ acabou de baixar e envie a mensagem.`;
            const url = `https://wa.me/${numeroLimpo}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
        }

        function fecharModal() { document.getElementById('shareModal').style.display = 'none'; }
        
        function baixarPDF() {
            if (pdfGerado) {
                pdfGerado.save(`Orcamento_${dadosOrcamento.clienteNome.replace(/\s+/g, '_')}.pdf`);
            }
        }
        
        function baixarImagem() {
            if (!dadosOrcamento) return;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            // ... (A l√≥gica para criar a imagem continua aqui)
        }
        
        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            carregarClientes();
            atualizarTabelaItens();
            document.getElementById('itemValorUnitario').addEventListener('input', (e) => formatarCampoMoeda(e.target));
        };
    </script>
</body>
</html>
