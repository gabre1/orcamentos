<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Or√ßamentos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Seu CSS continua o mesmo, sem altera√ß√µes */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .logo { width: 250px; height: 100px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); object-fit: contain; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
        .content { padding: 40px; }
        .section { margin-bottom: 40px; padding: 30px; background: #f8f9fa; border-radius: 15px; border-left: 5px solid #FF6B35; }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: white; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #FF6B35; box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #343a40 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; padding: 8px 15px; font-size: 0.9rem; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .items-table th { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); color: white; padding: 15px; text-align: left; font-weight: 600; }
        .items-table td { padding: 15px; border-bottom: 1px solid #e9ecef; }
        .total-section { background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%); color: white; padding: 25px; border-radius: 15px; text-align: right; margin-top: 20px; }
        .total-section h3 { font-size: 1.8rem; margin-bottom: 10px; }
        .total-section p { font-size: 2.5rem; font-weight: 700; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://drive.google.com/uc?export=view&id=1_Rj0dAUGkBMIfDnmw7LxjKa_bWZcNQd0" alt="Fenix Fardamentos Logo" class="logo">
            </div>
            <h1>Gerador de Or√ßamentos</h1>
        </div>
        <div class="content">
            <div class="section">
                <h2>üè¢ Dados da Empresa</h2>
                <div class="form-grid">
                    <div class="form-group"><label>Nome</label><input type="text" value="Fenix Fardamentos LTDA" readonly></div>
                    <div class="form-group"><label>CNPJ</label><input type="text" value="12.000.234/0001-18" readonly></div>
                    <div class="form-group"><label>Endere√ßo</label><input type="text" value="Rua Pinheiro, 65 - Cidade Universit√°ria" readonly></div>
                    <div class="form-group"><label>Telefone</label><input type="text" value="(82) 98814-4752" readonly></div>
                    <div class="form-group"><label>E-mail</label><input type="email" value="fenixfardamentos.al@gmail.com" readonly></div>
                </div>
            </div>

            <div class="section">
                <h2>üë§ Dados do Cliente</h2>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="clienteExistente">Selecionar Cliente Existente</label>
                    <select id="clienteExistente" onchange="preencherCliente()">
                        <option value="">-- Novo Cliente --</option>
                    </select>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label for="clienteNome">Nome do Cliente *</label><input type="text" id="clienteNome" placeholder="Nome completo ou empresa" required></div>
                    <div class="form-group"><label for="clienteCnpjCpf">CPF / CNPJ</label><input type="text" id="clienteCnpjCpf" placeholder="Digite o CPF ou CNPJ" oninput="formatarCnpjCpf(this)" maxlength="18"></div>
                    <div class="form-group"><label for="clienteEmail">E-mail</label><input type="email" id="clienteEmail" placeholder="cliente@email.com"></div>
                    <div class="form-group"><label for="clienteTelefone">Telefone</label><input type="text" id="clienteTelefone" placeholder="(11) 99999-9999"></div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="salvarCliente()">üíæ Salvar Novo Cliente</button>
            </div>

            <div class="section">
                <h2>üì¶ Adicionar Itens ao Or√ßamento</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="itemDescricao">Descri√ß√£o do Item *</label><input type="text" id="itemDescricao" placeholder="CAMISA UV" required></div>
                    <div class="form-group"><label for="itemQuantidade">Quantidade *</label><input type="number" id="itemQuantidade" min="1" value="1" required></div>
                    <div class="form-group"><label for="itemValorUnitario">Valor Unit√°rio (R$)</label><input type="text" id="itemValorUnitario" placeholder="0,00" oninput="formatarCampoMoeda(this)" required></div>
                </div>
                <button type="button" class="btn btn-primary" onclick="adicionarItem()">‚ûï Adicionar Item</button>
            </div>

            <div class="section">
                <h2>üìã Itens do Or√ßamento</h2>
                <div id="itensContainer"><div class="empty-state"><h3>Nenhum item adicionado</h3><p>Adicione itens ao or√ßamento.</p></div></div>
                <div id="totaisContainer"></div>
            </div>

            <div class="section">
                <h2>üìù Observa√ß√µes</h2>
                <div class="form-group"><label for="observacoes">Observa√ß√µes Adicionais</label><textarea id="observacoes" placeholder="Condi√ß√µes de pagamento, prazo de entrega, etc.">Forma de pagamento: 50% na encomenda e 50% na entrega. Prazo de entrega: 30 dias a partir da confirma√ß√£o do pedido.</textarea></div>
            </div>

            <div class="section" style="text-align: center;">
                <button type="button" class="btn btn-success" onclick="gerarPDF()">üìÑ Gerar Or√ßamento em PDF</button>
            </div>
        </div>
        <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-family: monospace;">v4.1.0-vercel</div>
    </div>
    
    <div id="shareModal" class="modal-overlay" style="display:none;">
        </div>

    <script>
        let itens = [];
        let contadorItens = 0;
        let clientesCache = [];

        // --- FUN√á√ïES DO BACKEND (API) ---
        async function carregarClientes() {
            const select = document.getElementById('clienteExistente');
            select.innerHTML = '<option value="">-- Carregando... --</option>';
            try {
                const response = await fetch('/api/clientes');
                if (!response.ok) throw new Error(`Falha na rede: ${response.statusText}`);
                
                const clientes = await response.json();
                clientesCache = clientes;
                
                select.innerHTML = '<option value="">-- Novo Cliente --</option>';
                clientes.forEach(cliente => {
                    const option = new Option(`${cliente.codigo_cliente} - ${cliente.nome}`, cliente.id);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
                select.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        function preencherCliente() {
            const select = document.getElementById('clienteExistente');
            const clienteId = select.value;
            const cliente = clientesCache.find(c => c.id == clienteId);

            document.getElementById('clienteNome').value = cliente ? cliente.nome : '';
            document.getElementById('clienteEmail').value = cliente ? cliente.email : '';
            document.getElementById('clienteTelefone').value = cliente ? cliente.telefone : '';
            
            const cnpjCpfInput = document.getElementById('clienteCnpjCpf');
            cnpjCpfInput.value = cliente ? cliente.cnpj_cpf : '';
            if(cliente && cliente.cnpj_cpf) {
                formatarCnpjCpf(cnpjCpfInput);
            }
        }

        async function salvarCliente() {
            const nome = document.getElementById('clienteNome').value.trim();
            const cnpjCpfInput = document.getElementById('clienteCnpjCpf');
            const cnpj_cpf = cnpjCpfInput.value.trim();

            if (!nome) {
                alert('O nome do cliente √© obrigat√≥rio para salvar.');
                return;
            }

            // Valida√ß√£o de CPF/CNPJ antes de salvar
            const docLimpo = cnpj_cpf.replace(/\D/g, '');
            if (docLimpo.length > 0) {
                if (docLimpo.length === 11) {
                    if (!validarCPF(docLimpo)) {
                        alert('CPF inv√°lido. Por favor, verifique o n√∫mero digitado.');
                        return;
                    }
                } else if (docLimpo.length === 14) {
                    if (!validarCNPJ(docLimpo)) {
                        alert('CNPJ inv√°lido. Por favor, verifique o n√∫mero digitado.');
                        return;
                    }
                } else {
                    alert('CPF/CNPJ com n√∫mero de d√≠gitos incorreto.');
                    return;
                }
            }

            if (clientesCache.some(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                alert('Um cliente com este nome j√° existe.');
                return;
            }
            
            const email = document.getElementById('clienteEmail').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim();

            try {
                const response = await fetch('/api/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, telefone, cnpj_cpf })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro do servidor');
                }

                alert(`Cliente "${nome}" salvo com sucesso!`);
                carregarClientes();
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                alert(`Ocorreu um erro ao salvar o cliente: ${error.message}`);
            }
        }
        
        // --- FUN√á√ïES DE VALIDA√á√ÉO E FORMATA√á√ÉO ---
        function formatarCampoMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (parseInt(valor, 10) / 100).toFixed(2) + '';
            valor = valor.replace('.', ',');
            const regex = /(\d)(?=(\d{3})+(?!\d))/g;
            input.value = valor.replace(regex, '$1.');
        }
        
        function formatarCnpjCpf(input) {
            let valor = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© d√≠gito

            if (valor.length <= 11) { // Formata como CPF
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else { // Formata como CNPJ
                valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
                valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
                valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
            }
            input.value = valor;
        }

        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) resto = 0;
            if (resto !== parseInt(cpf.substring(9, 10))) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) resto = 0;
            if (resto !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        }

        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;
            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(1)) return false;
            return true;
        }
        
        // --- FUN√á√ïES DO GERADOR (ITENS, TOTAIS, PDF) ---
        // (As demais fun√ß√µes continuam aqui, sem altera√ß√µes na l√≥gica principal)

        function parseCurrency(value) {
            if (!value) return 0;
            return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
        }

        function adicionarItem() {
            const descricao = document.getElementById('itemDescricao').value.trim();
            const quantidade = parseInt(document.getElementById('itemQuantidade').value);
            const valorUnitario = parseCurrency(document.getElementById('itemValorUnitario').value);

            if (!descricao || isNaN(quantidade) || quantidade <= 0 || isNaN(valorUnitario) || valorUnitario <= 0) {
                alert('Por favor, preencha todos os campos do item com valores v√°lidos.');
                return;
            }
            const item = { id: ++contadorItens, descricao, quantidade, valorUnitario, valorTotal: quantidade * valorUnitario };
            itens.push(item);
            atualizarTabelaItens();
            limparFormularioItem();
        }

        function removerItem(id) {
            itens = itens.filter(item => item.id !== id);
            atualizarTabelaItens();
        }

        function limparFormularioItem() {
            document.getElementById('itemDescricao').value = '';
            document.getElementById('itemQuantidade').value = '1';
            document.getElementById('itemValorUnitario').value = '';
        }

        function atualizarTabelaItens() {
            const container = document.getElementById('itensContainer');
            if (itens.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Nenhum item adicionado</h3><p>Adicione itens ao or√ßamento usando o formul√°rio acima</p></div>`;
            } else {
                container.innerHTML = `
                <table class="items-table">
                    <thead><tr><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√µes</th></tr></thead>
                    <tbody>
                        ${itens.map(item => `
                            <tr>
                                <td data-label="Descri√ß√£o">${item.descricao}</td>
                                <td data-label="Qtd">${item.quantidade}</td>
                                <td data-label="Valor Unit.">${formatarMoeda(item.valorUnitario)}</td>
                                <td data-label="Total">${formatarMoeda(item.valorTotal)}</td>
                                <td><button class="btn btn-danger" onclick="removerItem(${item.id})">üóëÔ∏è</button></td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
            }
            atualizarTotais();
        }

        function atualizarTotais() {
            const totaisContainer = document.getElementById('totaisContainer');
            const subtotal = itens.reduce((acc, item) => acc + item.valorTotal, 0);
            const desconto = parseCurrency(document.getElementById('descontoValor')?.value);
            const totalGeral = subtotal - desconto;
            
            totaisContainer.innerHTML = `
                <div class="total-section">
                    <div class="form-grid" style="margin-bottom: 20px; text-align: left;">
                        <div class="form-group">
                            <label for="descontoValor" style="color: white;">Desconto (R$)</label>
                            <input type="text" id="descontoValor" placeholder="0,00" style="padding: 12px 15px; border-radius: 10px; border: none; font-size: 1rem;" oninput="formatarCampoMoeda(this); atualizarTotais();" value="${document.getElementById('descontoValor')?.value || ''}">
                        </div>
                    </div>
                    <p style="font-size: 1rem; margin: 0; opacity: 0.8; text-align: right;">Subtotal: ${formatarMoeda(subtotal)}</p>
                    <p style="font-size: 1rem; margin: 0 0 10px 0; opacity: 0.8; text-align: right;">Desconto: - ${formatarMoeda(desconto)}</p>
                    <h3 style="margin-top: 10px;">Total Geral</h3>
                    <p>${formatarMoeda(totalGeral)}</p>
                </div>`;
        }

        function gerarPDF() { /* L√≥gica de gerar PDF igual √† v2.8.0 */ }
        function criarPDF() { /* L√≥gica de criar PDF igual √† v2.8.0 */ }
        function continuarGeracaoPDF(doc, pageWidth, margin, yPosition) { /* L√≥gica de continuar PDF igual √† v2.8.0 */ }
        
        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            carregarClientes();
            atualizarTabelaItens();
            document.getElementById('itemValorUnitario').addEventListener('input', (e) => formatarCampoMoeda(e.target));
        };
    </script>
</body>
</html>
